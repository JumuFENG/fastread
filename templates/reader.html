{% extends "base.html" %}

{% block title %}阅读器 - FastRead{% endblock %}

{% block content %}
<!-- 固定工具栏 -->
<div class="reader-toolbar">
    <button class="btn btn-outline-secondary btn-sm" onclick="toggleChapterList()" title="章节目录">
        <i class="bi bi-list"></i>
    </button>
    <button class="btn btn-outline-secondary btn-sm" onclick="toggleSettings()" title="阅读设置">
        <i class="bi bi-gear"></i>
    </button>
    <button class="btn btn-outline-success btn-sm" onclick="toggleExcerpts()" title="摘录管理">
        <i class="bi bi-bookmark"></i>
    </button>
    <button class="btn btn-outline-info btn-sm" onclick="toggleTemplates()" title="模板管理">
        <i class="bi bi-file-text"></i>
    </button>
    <button class="btn btn-outline-primary btn-sm" onclick="toggleRewrite()" title="重写/创作">
        <i class="bi bi-pencil-square"></i>
    </button>
    <button class="btn btn-outline-warning btn-sm" onclick="toggleSensitiveWords()" title="敏感词替换">
        <i class="bi bi-shield-check"></i>
    </button>
</div>

<div class="reader-container">
    <div class="row">
        <!-- 章节列表侧边栏 -->
        <div class="col-md-3 d-none">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">章节目录</h6>
                </div>
                <div class="card-body p-0">
                    <div id="chapterList" class="chapter-list">
                        <!-- 章节列表将通过JavaScript加载 -->
                    </div>
                    <div class="text-center p-2" id="chapterListControls" style="display: none;">
                        <button class="btn btn-outline-secondary btn-sm me-2" onclick="showMoreChapters('prev')">
                            <i class="bi bi-chevron-up"></i> 更多
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="showMoreChapters('next')">
                            <i class="bi bi-chevron-down"></i> 更多
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 阅读区域 -->
        <div id="mainContent" class="col-md-12">
            <div class="reader-header mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4><a id="bookTitle" href="#" target="_blank">加载中...</a></h4>
                        <h5 id="chapterTitle" class="text-muted">加载中...</h5>
                    </div>
                </div>
            </div>

            <!-- 阅读设置面板 -->
            <div id="settingsPanel" class="floating-panel d-none">
                <div class="panel-header">
                    <h6>阅读设置</h6>
                    <button type="button" class="btn-close" onclick="hideAllPanels()" aria-label="关闭"></button>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">字体大小</label>
                            <input type="range" class="form-range" id="fontSizeSlider" min="12" max="24" value="16"
                                onchange="changeFontSize(this.value)">
                            <small class="text-muted">当前: <span id="fontSizeValue">16px</span></small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">行间距</label>
                            <input type="range" class="form-range" id="lineHeightSlider" min="1.2" max="2.5" step="0.1"
                                value="1.6" onchange="changeLineHeight(this.value)">
                            <small class="text-muted">当前: <span id="lineHeightValue">1.6</span></small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">背景主题</label>
                            <select class="form-select form-select-sm" id="themeSelect"
                                onchange="changeTheme(this.value)">
                                <option value="light">浅色</option>
                                <option value="dark">深色</option>
                                <option value="sepia">护眼米色</option>
                                <option value="green">护眼绿色</option>
                                <option value="blue">护眼蓝色</option>
                                <option value="gray">护眼灰色</option>
                                <option value="night">夜间模式</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">字体</label>
                            <select class="form-select form-select-sm" id="fontSelect"
                                onchange="changeFont(this.value)">
                                <option value="system">系统默认</option>
                                <option value="serif">宋体</option>
                                <option value="sans-serif">黑体</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-check-label">
                                <input type="checkbox" class="form-check-input" id="autoScrollCheckbox"
                                    onchange="toggleAutoScroll()">
                                自动滚动</label>
                            <input type="number" class="form-control form-control-sm" id="autoScrollSpeed"
                                placeholder="滚动速度 (ms)" value="10" min="20"
                                style="width: 70px; display: inline-block; margin-left: 10px;"
                                onchange="updateAutoScrollSpeed()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 摘录管理面板 -->
            <div id="excerptsPanel" class="floating-panel d-none">
                <div class="panel-header">
                    <h6>摘录管理</h6>
                    <button type="button" class="btn-close" onclick="hideAllPanels()" aria-label="关闭"></button>
                </div>
                <div class="panel-body">
                    <div id="excerptsList" class="excerpts-list">
                        <!-- 摘录列表 -->
                    </div>
                </div>
            </div>

            <!-- 模板管理面板 -->
            <div id="templatesPanel" class="floating-panel d-none">
                <div class="panel-header">
                    <h6>模板管理</h6>
                    <button type="button" class="btn-close" onclick="hideAllPanels()" aria-label="关闭"></button>
                </div>
                <div class="panel-body">
                    <div class="mb-3">
                        <button class="btn btn-outline-info btn-sm" onclick="loadUserTemplates()">
                            <i class="bi bi-list"></i> 我的模板
                        </button>
                    </div>

                    <!-- 模板列表 -->
                    <div id="templatesList">
                        <!-- 模板列表 -->
                    </div>

                    <!-- 创建模板表单 -->
                    <div id="createTemplateForm" class="d-none">
                        <div class="mb-3">
                            <label class="form-label">新建模板</label>
                            <input type="text" class="form-control" id="templateName" placeholder="输入模板名称">
                        </div>
                        <div class="mb-3">
                            <textarea class="form-control" id="templateContent" rows="4" placeholder="模板内容"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">关键词设置</label>
                            <div id="keywordsList" class="d-flex flex-wrap gap-2"></div>
                            <div class="mt-2 d-flex gap-2">
                                <input type="text" class="form-control" id="customKeyword" placeholder="关键词" style="width: 100px;" autocomplete="off">
                                <input type="text" class="form-control" id="customKeywordValue" placeholder="文本内容" style="width: 150px;" autocomplete="off">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addCustomKeyword()">
                                    <i class="bi bi-plus"></i> 添加
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <input type="text" class="form-control" id="templateTags" placeholder="输入标签，用逗号分隔">
                        </div>
                        <div class="mb-3">
                            <textarea class="form-control" id="templateDescription" rows="2"
                                placeholder="模板描述"></textarea>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success btn-sm" onclick="saveTemplate()">
                                <i class="bi bi-save"></i> 保存模板
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 重写/创作面板 -->
            <div id="rewritePanel" class="floating-panel d-none">
                <div class="panel-header">
                    <h6>重写/创作</h6>
                    <button type="button" class="btn-close" onclick="hideAllPanels()" aria-label="关闭"></button>
                </div>
                <div class="panel-body">
                    <div class="mb-3">
                        <button class="btn btn-primary btn-sm" onclick="startRewrite()">
                            <i class="bi bi-pencil"></i> 重写选中内容
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="startInsert()">
                            <i class="bi bi-plus-circle"></i> 插入新内容
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="loadUserRewrites()">
                            <i class="bi bi-list"></i> 我的重写
                        </button>
                    </div>

                    <!-- 重写表单 -->
                    <div id="rewriteForm" class="d-none">
                        <div class="mb-3">
                            <label class="form-label">原始内容</label>
                            <textarea class="form-control" id="originalContent" rows="3" readonly></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">重写内容</label>
                            <textarea class="form-control" id="rewrittenContent" rows="4"
                                placeholder="输入重写后的内容"></textarea>
                        </div>
                        <div class="mb-3" id="templateSelector" style="display: none;">
                            <label class="form-label">应用模板</label>
                            <select class="form-select" id="templateSelect">
                                <option value="">选择模板</option>
                            </select>
                            <button type="button" class="btn btn-outline-info btn-sm mt-2"
                                onclick="applySelectedTemplate()">
                                应用模板
                            </button>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success btn-sm" onclick="saveRewrite()">
                                <i class="bi bi-save"></i> 保存重写
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="cancelRewrite()">
                                取消
                            </button>
                        </div>
                    </div>

                    <!-- 重写列表 -->
                    <div id="rewritesList">
                        <!-- 重写列表 -->
                    </div>
                </div>
            </div>

            <!-- 敏感词替换面板 -->
            <div id="sensitiveWordsPanel" class="floating-panel d-none">
                <div class="panel-header">
                    <h6>敏感词替换</h6>
                    <button type="button" class="btn-close" onclick="hideAllPanels()" aria-label="关闭"></button>
                </div>
                <div class="panel-body">
                    <div id="sensitiveWordsList" class="sensitive-words-list">
                        <!-- 敏感词列表 -->
                    </div>
                    <div class="mb-3">
                        <label class="form-label">添加敏感词</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="newSensitiveWord" placeholder="输入敏感词">
                            <input type="text" class="form-control" id="replacementWord" placeholder="替换词">
                            <button class="btn btn-primary" onclick="addSensitiveWord()">添加</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 章节内容 -->
            <div id="chapterContent" class="reader-content">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                </div>
            </div>

            <!-- 导航按钮 -->
            <div class="reader-navigation mt-4">
                <div class="d-flex justify-content-between">
                    <button id="prevChapter" class="btn btn-link" onclick="prevChapter()" disabled>
                        <i class="bi bi-chevron-left"></i>
                        <span class="d-none d-md-inline">上一章</span>
                    </button>
                    <button class="btn btn-link btn-sm" onclick="toggleScrollTimer()" title="自动滚动">
                        <i class="bi bi-skip-end"></i>
                    </button>
                    <div class="chapter-info">
                        <input id="chapterProgress" onchange="jumpToChapter()"></input>/&nbsp<span
                            id="totalChapters">1</span>
                    </div>
                    <button id="nextChapter" class="btn btn-link" onclick="nextChapter()" disabled>
                        <span class="d-none d-md-inline">下一章</span>
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 移动端章节列表模态框 -->
<div class="modal fade" id="chapterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">章节目录</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="mobileChapterList" class="chapter-list">
                    <!-- 移动端章节列表 -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
{% endblock %}

{% block scripts %}
<script>
    // 本地showAlert函数
    function showAlert(message, type = 'info') {
        console.log(`[${type.toUpperCase()}] ${message}`);

        // 创建简单的提示
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <span class="flex-grow-1">${message}</span>
            <button type="button" class="btn-close ms-2" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;

        document.body.appendChild(alertDiv);

        // 3秒后自动移除
        setTimeout(() => {
            if (alertDiv.parentElement) {
                alertDiv.remove();
            }
        }, 3000);
    }

    let currentBook = null;
    let chapters = [];
    let currentChapterIndex = 0;
    let readingProgress = null;
    let lastSavedProgress = null; // 跟踪上次保存的进度
    let chapterDisplayRange = { start: 0, end: 20 }; // 默认显示前20章
    const CHAPTER_DISPLAY_COUNT = 20; // 每次显示的章节数量
    let excerpts = [];
    let sensitiveWords = {};
    let autoScrollEnabled = false;
    let autoScrollSpeed = 30;

    document.addEventListener('DOMContentLoaded', function () {
        const bookId = {{ book_id | tojson
    }};

    loadBook(bookId).then(() => {
        loadSensitiveWords();
    });
    loadChapters(bookId).then(() => {
        loadExcerpts();
        loadReadingProgress(bookId);
    });

    // 加载阅读设置
    loadReaderSettings();

    // 键盘导航
    document.addEventListener('keydown', function (e) {
        if (e.key === 'ArrowLeft') {
            prevChapter();
        } else if (e.key === 'ArrowRight') {
            nextChapter();
        } else if (e.key === 'Escape') {
            // ESC键关闭所有面板
            hideAllPanels();
        }
    });

    // 窗口大小变化监听
    window.addEventListener('resize', function () {
        const isMobile = window.innerWidth <= 768;
        const settingsPanel = document.getElementById('settingsPanel');

        if (!settingsPanel.classList.contains('d-none')) {
            if (isMobile) {
                document.body.classList.add('mobile-settings-active');
            } else {
                document.body.classList.remove('mobile-settings-active');
            }
        }
    });
    });

    async function loadBook(bookId) {
        try {
            const response = await fetch(`/api/books/${bookId}`);
            currentBook = await response.json();
            document.getElementById('bookTitle').textContent = currentBook.title;
            document.getElementById('bookTitle').href = currentBook.source_url;
            return currentBook;
        } catch (error) {
            console.error('加载书籍信息失败:', error);
        }
    }

    async function loadChapters(bookId) {
        try {
            const response = await fetch(`/api/books/${bookId}/chapters`);
            chapters = await response.json();

            updateChapterList();
            updateChapterProgress();

        } catch (error) {
            console.error('加载章节列表失败:', error);
        }
    }

    function updateChapterList() {
        // 如果章节数量较多，只显示当前章节附近的章节
        if (chapters.length > CHAPTER_DISPLAY_COUNT) {
            const halfRange = Math.floor(CHAPTER_DISPLAY_COUNT / 2);
            chapterDisplayRange.start = Math.max(0, currentChapterIndex - halfRange);
            chapterDisplayRange.end = Math.min(chapters.length, chapterDisplayRange.start + CHAPTER_DISPLAY_COUNT);

            // 如果接近末尾，调整起始位置
            if (chapterDisplayRange.end === chapters.length) {
                chapterDisplayRange.start = Math.max(0, chapters.length - CHAPTER_DISPLAY_COUNT);
            }

            document.getElementById('chapterListControls').style.display = 'block';
        } else {
            chapterDisplayRange.start = 0;
            chapterDisplayRange.end = chapters.length;
            document.getElementById('chapterListControls').style.display = 'none';
        }

        const visibleChapters = chapters.slice(chapterDisplayRange.start, chapterDisplayRange.end);

        const chapterListHtml = visibleChapters.map((chapter, index) => {
            const actualIndex = chapterDisplayRange.start + index;
            return `
            <div class="chapter-item ${actualIndex === currentChapterIndex ? 'active' : ''}" 
                 onclick="loadChapter(${actualIndex})">
                <span class="chapter-number">${chapter.chapter_number}</span>
                <span class="chapter-title">${chapter.title}</span>
            </div>
        `;
        }).join('');

        // 添加范围提示
        const rangeInfo = chapters.length > CHAPTER_DISPLAY_COUNT ?
            `<div class="text-muted small p-2 text-center">显示 ${chapterDisplayRange.start + 1}-${chapterDisplayRange.end} / ${chapters.length} 章</div>` : '';

        document.getElementById('chapterList').innerHTML = rangeInfo + chapterListHtml;

        // 移动端显示全部章节
        const mobileChapterListHtml = chapters.map((chapter, index) => `
            <div class="chapter-item ${index === currentChapterIndex ? 'active' : ''}" 
                 onclick="loadChapter(${index}); bootstrap.Modal.getInstance(document.getElementById('chapterModal')).hide();">
                <span class="chapter-number">${chapter.chapter_number}</span>
                <span class="chapter-title">${chapter.title}</span>
            </div>
        `).join('');
        document.getElementById('mobileChapterList').innerHTML = mobileChapterListHtml;
    }

    async function loadChapter(chapterIndex) {
        if (chapterIndex < 0 || chapterIndex >= chapters.length) {
            return;
        }

        currentChapterIndex = chapterIndex;
        const chapter = chapters[chapterIndex];

        // 显示加载状态
        const contentDiv = document.getElementById('chapterContent');
        contentDiv.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <div class="mt-2">正在获取章节内容...</div>
        </div>
    `;

        try {
            const apiUrl = `/api/books/${currentBook.id}/chapters/${chapter.chapter_number}`;
            console.log('请求章节内容:', apiUrl);

            const response = await fetch(apiUrl);
            console.log('API响应状态:', response.status, response.statusText);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const chapterData = await response.json();

            document.getElementById('chapterTitle').textContent = chapterData.title;

            // 处理章节内容
            let content = chapterData.content || '章节内容为空';
            currentBook.currentChapterData = chapterData;

            // 应用敏感词过滤
            applySensitiveWordFilter(chapterData);

            // 更新章节列表
            updateChapterList();

            // 更新导航按钮状态
            document.getElementById('prevChapter').disabled = chapterIndex === 0;
            document.getElementById('nextChapter').disabled = chapterIndex === chapters.length - 1;

            updateChapterProgress();

            // 强制保存阅读进度（章节切换时）
            saveReadingProgress(true);

            // 滚动到顶部
            window.scrollTo(0, 0);
            contentDiv.focus();
            if (autoScrollTimer) {
                if (autoScrollEnabled) {
                    startAutoScroll();
                } else {
                    stopAutoScroll();
                }
            }

            // 添加文本选择事件监听
            addTextSelectionListener();

        } catch (error) {
            console.error('加载章节内容失败:', error);
            contentDiv.innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="bi bi-exclamation-triangle"></i> 加载失败</h5>
                <p>无法获取章节内容，请检查网络连接或稍后重试。</p>
                <button class="btn btn-outline-danger" onclick="loadChapter(${chapterIndex})">
                    <i class="bi bi-arrow-clockwise"></i> 重试
                </button>
            </div>
        `;
            showAlert('加载章节失败', 'danger');
        }
    }

    function preloadChapter(chapterIndex) {
        // 预加载指定章节内容（不渲染，只缓存）
        if (chapterIndex < 0 || chapterIndex >= chapters.length) return;

        const chapter = chapters[chapterIndex];
        const apiUrl = `/api/books/${currentBook.id}/chapters/${chapter.chapter_number}/preload`;

        fetch(apiUrl, { method: 'POST' })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`预加载失败: HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`章节 ${chapter.chapter_number} 预加载成功`);
            })
            .catch(error => {
                console.warn(`章节 ${chapter.chapter_number} 预加载失败:`, error);
            });
    }

    async function loadReadingProgress(bookId) {
        currentChapterIndex = 0;
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                let localReadingProgress = JSON.parse(localStorage.getItem('localReadingProgress'));
                if (localReadingProgress && localReadingProgress[bookId]) {
                    readingProgress = localReadingProgress[bookId];
                    currentChapterIndex = readingProgress.current_chapter - 1;
                    // 初始化上次保存的进度
                    lastSavedProgress = { ...readingProgress };
                    console.log('加载本地阅读进度，从第', currentChapterIndex + 1, '章开始');
                }
                loadChapter(currentChapterIndex);
                preloadChapter(currentChapterIndex + 1);
                return;
            }

            const response = await fetch(`/api/reading/progress/${bookId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                readingProgress = await response.json();
                currentChapterIndex = readingProgress.current_chapter - 1;
                // 初始化上次保存的进度
                lastSavedProgress = { ...readingProgress };
                console.log('加载阅读进度，从第', currentChapterIndex + 1, '章开始');
                loadChapter(currentChapterIndex);
                preloadChapter(currentChapterIndex + 1);
            } else {
                console.log('获取阅读进度失败，从第一章开始');
                loadChapter(currentChapterIndex);
            }
        } catch (error) {
            console.error('加载阅读进度失败:', error);
            // 如果没有登录或加载失败，默认从第一章开始
            console.log('异常情况，从第一章开始');
            loadChapter(currentChapterIndex);
        }
    }

    async function saveReadingProgress(force = false) {
        const newProgress = {
            current_chapter: currentChapterIndex + 1,
            reading_position: window.pageYOffset
        };

        // 检查进度是否有变化（除非强制保存）
        if (!force && lastSavedProgress &&
            lastSavedProgress.current_chapter === newProgress.current_chapter &&
            Math.abs(lastSavedProgress.reading_position - newProgress.reading_position) < 100) {
            // 如果章节没变且滚动位置变化小于100px，则不保存
            console.log('阅读进度无显著变化，跳过保存');
            return;
        }

        readingProgress = newProgress;

        const token = localStorage.getItem('token');
        if (!token) {
            let localReadingProgress = JSON.parse(localStorage.getItem('localReadingProgress')) ?? {};
            localReadingProgress[currentBook.id] = readingProgress;
            localStorage.setItem('localReadingProgress', JSON.stringify(localReadingProgress));

            // 更新上次保存的进度
            lastSavedProgress = { ...readingProgress };
            console.log('本地阅读进度已保存:', readingProgress);
            return;
        }

        try {
            await fetch(`/api/reading/progress/${currentBook.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(readingProgress)
            });

            // 保存成功后更新上次保存的进度
            lastSavedProgress = { ...readingProgress };
            console.log('服务器阅读进度已保存:', readingProgress);
        } catch (error) {
            console.error('保存阅读进度失败:', error);
        }
    }

    function prevChapter() {
        if (currentChapterIndex > 0) {
            loadChapter(currentChapterIndex - 1);
        }
    }

    function nextChapter() {
        let i2 = currentChapterIndex + 2;
        if (currentChapterIndex + 1 < chapters.length) loadChapter(currentChapterIndex + 1);
        if (i2 < chapters.length) preloadChapter(i2);
    }

    function updateChapterProgress() {
        document.getElementById('chapterProgress').value = currentChapterIndex + 1;
        document.getElementById('totalChapters').textContent = chapters.length;
    }

    let autoScrollTimer = null;

    function toggleAutoScroll() {
        autoScrollEnabled = !autoScrollEnabled;
    }

    function toggleScrollTimer() {
        if (autoScrollTimer) {
            stopAutoScroll();
        } else {
            startAutoScroll();
        }
    }

    function updateAutoScrollSpeed() {
        const speedInput = document.getElementById('autoScrollSpeed');
        autoScrollSpeed = parseInt(speedInput.value);
    }

    function startAutoScroll() {
        stopAutoScroll(); // 防止多重定时器
        autoScrollTimer = setInterval(() => {
            // 到达底部时自动关闭
            if ((window.innerHeight + window.scrollY) < document.body.scrollHeight - autoScrollSpeed) {
                // 每次向下滚动2像素
                window.scrollBy(0, autoScrollSpeed);
            }
        }, 500);
    }

    function stopAutoScroll() {
        if (autoScrollTimer) {
            clearInterval(autoScrollTimer);
            autoScrollTimer = null;
        }
    }

    function toggleChapterList() {
        if (window.innerWidth < 768) {
            new bootstrap.Modal(document.getElementById('chapterModal')).show();
        } else {
            const sidebar = document.querySelector('.col-md-3');
            // 使用ID选择器，更稳定可靠
            const mainContent = document.getElementById('mainContent');

            if (sidebar.classList.contains('d-none')) {
                // 显示侧边栏
                sidebar.classList.remove('d-none');
                sidebar.classList.add('d-md-block');
                // 调整正文宽度为9列
                mainContent.classList.remove('col-md-12');
                mainContent.classList.add('col-md-9');
            } else {
                // 隐藏侧边栏
                sidebar.classList.add('d-none');
                sidebar.classList.remove('d-md-block');
                // 调整正文宽度为12列（全宽）
                mainContent.classList.remove('col-md-9');
                mainContent.classList.add('col-md-12');
            }
        }
    }

    function toggleSettings() {
        hideAllPanels();
        const panel = document.getElementById('settingsPanel');
        panel.classList.toggle('d-none');

        // 检查是否为移动端
        const isMobile = window.innerWidth <= 768;

        if (!panel.classList.contains('d-none')) {
            if (autoScrollTimer) {
                stopAutoScroll();
            }

            // 移动端特殊处理
            if (isMobile) {
                document.body.classList.add('mobile-settings-active');
                // 滚动到设置面板
                setTimeout(() => {
                    panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        } else {
            if (autoScrollEnabled) {
                startAutoScroll();
            }

            // 移除移动端特殊样式
            if (isMobile) {
                document.body.classList.remove('mobile-settings-active');
            }
        }
    }

    function toggleExcerpts() {
        hideAllPanels();
        const panel = document.getElementById('excerptsPanel');
        panel.classList.toggle('d-none');
        displayExcerpts(excerpts)
    }

    function toggleTemplates() {
        const token = localStorage.getItem('token');
        if (!token) {
            showAlert('模板功能需要登录后使用', 'warning');
            return;
        }

        hideAllPanels();
        const panel = document.getElementById('templatesPanel');
        panel.classList.toggle('d-none');
        createTemplateFromSelection();
        if (!panel.classList.contains('d-none')) {
            loadUserTemplates();
        }
    }

    function toggleRewrite() {
        const token = localStorage.getItem('token');
        if (!token) {
            showAlert('重写功能需要登录后使用', 'warning');
            return;
        }

        hideAllPanels();
        const panel = document.getElementById('rewritePanel');
        panel.classList.toggle('d-none');
        if (!panel.classList.contains('d-none')) {
            loadUserRewrites();
            loadTemplatesForRewrite();
        }
    }

    function toggleSensitiveWords() {
        hideAllPanels();
        const panel = document.getElementById('sensitiveWordsPanel');
        panel.classList.toggle('d-none');
        showSensitiveWords();
        applySensitiveWordFilter(currentBook.currentChapterData);
    }

    function hideAllPanels() {
        document.getElementById('settingsPanel').classList.add('d-none');
        document.getElementById('excerptsPanel').classList.add('d-none');
        document.getElementById('templatesPanel').classList.add('d-none');
        document.getElementById('rewritePanel').classList.add('d-none');
        document.getElementById('sensitiveWordsPanel').classList.add('d-none');

        // 移除移动端特殊样式
        document.body.classList.remove('mobile-settings-active');

        // 恢复自动滚动
        if (autoScrollEnabled) {
            startAutoScroll();
        }
    }

    // 阅读设置功能
    function changeFontSize(size) {
        document.getElementById('fontSizeValue').textContent = size + 'px';
        document.querySelector('.reader-content').style.fontSize = size + 'px';
        localStorage.setItem('readerFontSize', size);
    }

    function changeLineHeight(height) {
        document.getElementById('lineHeightValue').textContent = height;
        document.querySelector('.reader-content').style.lineHeight = height;
        localStorage.setItem('readerLineHeight', height);
    }

    function changeTheme(theme) {
        const content = document.querySelector('.reader-content');
        const body = document.body;

        // 移除所有主题类
        content.className = content.className.replace(/theme-\w+/g, '');
        body.className = body.className.replace(/theme-\w+/g, '');

        // 添加新主题类
        content.classList.add('theme-' + theme);
        body.classList.add('theme-' + theme);

        localStorage.setItem('readerTheme', theme);
    }

    function changeFont(font) {
        document.querySelector('.reader-content').style.fontFamily = font;
        localStorage.setItem('readerFont', font);
    }

    function loadReaderSettings() {
        const fontSize = localStorage.getItem('readerFontSize') || '16';
        const lineHeight = localStorage.getItem('readerLineHeight') || '1.6';
        const theme = localStorage.getItem('readerTheme') || 'light';
        const font = localStorage.getItem('readerFont') || 'system';

        document.getElementById('fontSizeSlider').value = fontSize;
        document.getElementById('lineHeightSlider').value = lineHeight;
        document.getElementById('themeSelect').value = theme;
        document.getElementById('fontSelect').value = font;
        document.getElementById('autoScrollCheckbox').checked = autoScrollEnabled;
        document.getElementById('autoScrollSpeed').value = autoScrollSpeed;

        changeFontSize(fontSize);
        changeLineHeight(lineHeight);
        changeTheme(theme);
        changeFont(font);
    }

    async function loadSensitiveWords() {
        // 未登录，从本地存储加载
        sensitiveWords = JSON.parse(localStorage.getItem('sensitiveWords') || '{}');
        const token = localStorage.getItem('token');
        if (!token) {
            return;
        }
        // 已登录，从服务器加载
        try {
            const response = await fetch(`/api/sensitive-words/?book_id=${currentBook.id}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const serverWords = await response.json();
                // 转换为原有格式
                if (sensitiveWords[currentBook.id]) {
                    sensitiveWords[currentBook.id].forEach(word => {
                        if (word.id) {
                            return;
                        }
                        serverWords.push(word);
                    });
                }
                sensitiveWords[currentBook.id] = serverWords
                console.log('从服务器加载敏感词成功');
            }
        } catch (error) {
            console.error('加载敏感词失败:', error);
        }
    }

    async function saveSensitiveWords() {
        // 未登录，保存到本地存储
        // 已登录时为了兼容性，也保存到本地存储作为备份
        localStorage.setItem('sensitiveWords', JSON.stringify(sensitiveWords));
    }

    // 敏感词过滤功能
    function applySensitiveWordFilter(chapterData) {
        let filteredContent = chapterData.content;
        if (sensitiveWords[currentBook.id]) {
            sensitiveWords[currentBook.id].forEach(wordPair => {
                if (!wordPair.enabled) {
                    return;
                }
                const regex = new RegExp(wordPair.original, 'gi');
                filteredContent = filteredContent.replace(regex, wordPair.replacement);
            });
        }

        // 将换行符转换为段落
        const paragraphs = filteredContent.split('\n\n').filter(p => p.trim().length > 0);
        const formattedContent = paragraphs.map(p => `<p>${p.trim()}</p>`).join('');

        const contentDiv = document.getElementById('chapterContent');
        contentDiv.innerHTML = `
            <div class="chapter-text">
                ${formattedContent}<p></p>
            </div>
            ${!chapterData.is_cached ? '<div class="text-muted small mt-3"><i class="bi bi-cloud-download"></i> 实时获取</div>' : ''}
        `;
        return filteredContent;
    }

    async function addSensitiveWord() {
        const originalWord = document.getElementById('newSensitiveWord').value.trim();
        const replacementWord = document.getElementById('replacementWord').value.trim();

        if (!originalWord) {
            showAlert('请输入敏感词', 'warning');
            return;
        }
        if (replacementWord == undefined || replacementWord === null) {
            showAlert('请输入替换词', 'warning');
            return;
        }

        if (!sensitiveWords[currentBook.id]) {
            sensitiveWords[currentBook.id] = [];
        }

        // 检查是否已存在
        const exists = sensitiveWords[currentBook.id].some(pair => pair.original === originalWord);
        if (exists) {
            showAlert('该敏感词已存在', 'warning');
            return;
        }

        const token = localStorage.getItem('token');

        if (token) {
            // 已登录，保存到服务器
            try {
                const response = await fetch('/api/sensitive-words/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        book_id: currentBook.id,
                        original: originalWord,
                        replacement: replacementWord,
                        enabled: true
                    })
                });

                if (response.ok) {
                    const newWord = await response.json();
                    sensitiveWords[currentBook.id].push(newWord);
                    showAlert('敏感词添加成功', 'success');
                } else {
                    const error = await response.json();
                    showAlert(error.detail || '添加敏感词失败', 'danger');
                    return;
                }
            } catch (error) {
                console.error('添加敏感词失败:', error);
                showAlert('添加敏感词失败', 'danger');
                return;
            }
        } else {
            // 未登录，保存到本地
            sensitiveWords[currentBook.id].push({ original: originalWord, replacement: replacementWord, enabled: true });
            saveSensitiveWords();
            showAlert('敏感词添加成功（本地）', 'success');
        }

        document.getElementById('newSensitiveWord').value = '';
        document.getElementById('replacementWord').value = '';

        showSensitiveWords();
        applySensitiveWordFilter(currentBook.currentChapterData);
    }

    async function toggleSensitiveWord(index) {
        const word = sensitiveWords[currentBook.id][index];
        word.enabled = !word.enabled;

        const token = localStorage.getItem('token');

        if (token) {
            // 已登录且有ID，更新服务器
            try {
                const url = `/api/sensitive-words/${word.id ? word.id : ''}`;
                const method = word.id ? 'PUT' : 'POST';
                const body = word.id ? { enabled: word.enabled } : {
                    book_id: currentBook.id,
                    original: word.original,
                    replacement: word.replacement,
                    enabled: word.enabled
                }
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    // 更新失败，恢复状态
                    word.enabled = !word.enabled;
                    showAlert('更新敏感词状态失败', 'danger');
                    return;
                }

                if (response.ok && !word.id) {
                    const newWord = await response.json();
                    word.id = newWord.id;
                    word.book_id = newWord.book_id;
                }
            } catch (error) {
                console.error('更新敏感词状态失败:', error);
                word.enabled = !word.enabled;
                showAlert('更新敏感词状态失败', 'danger');
                return;
            }
        } else {
            // 未登录，保存到本地
            saveSensitiveWords();
        }

        showSensitiveWords();
        applySensitiveWordFilter(currentBook.currentChapterData);
    }

    async function removeSensitiveWord(index) {
        if (!sensitiveWords[currentBook.id]) {
            return;
        }

        const word = sensitiveWords[currentBook.id][index];
        const token = localStorage.getItem('token');

        if (token && word.id) {
            // 已登录且有ID，从服务器删除
            try {
                const response = await fetch(`/api/sensitive-words/${word.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    showAlert('删除敏感词失败', 'danger');
                    return;
                }
            } catch (error) {
                console.error('删除敏感词失败:', error);
                showAlert('删除敏感词失败', 'danger');
                return;
            }
        }

        // 从本地数组中删除
        sensitiveWords[currentBook.id].splice(index, 1);

        if (!token) {
            // 未登录，保存到本地存储
            saveSensitiveWords();
        }

        showSensitiveWords();
        showAlert('敏感词删除成功', 'success');
        applySensitiveWordFilter(currentBook.currentChapterData);
    }

    function showSensitiveWords() {
        const container = document.getElementById('sensitiveWordsList');
        if (!sensitiveWords[currentBook.id] || sensitiveWords[currentBook.id].length === 0) {
            container.innerHTML = '<div class="text-muted text-center">暂无敏感词</div>';
            return;
        }

        const html = sensitiveWords[currentBook.id].map((wordPair, index) => `
            <div class="sensitive-word-item">
                <div class="word-pair">
                    <input class="form-check-input" type="checkbox" ${wordPair.enabled ? 'checked' : ''} onchange="toggleSensitiveWord(${index})">
                    <span class="original-word">${wordPair.original}</span>
                    <span>→</span>
                    <span class="replacement-word">${wordPair.replacement}</span>
                </div>
                <button class="btn btn-outline-danger btn-sm" onclick="removeSensitiveWord(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `).join('');

        container.innerHTML = html;
    }

    // 摘录功能
    function addTextSelectionListener() {
        document.addEventListener('mouseup', function (e) {
            if (e.target.closest('.selection-tooltip') || e.target.closest('.floating-panel')) {
                return;
            }
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && selection.toString().trim().length > 0) {
                Promise.resolve().then(() => {
                    showSelectionTooltip(selection, e.clientX, e.clientY);
                });
            }
        });
    }

    // 存储当前选中的文本，避免在 onclick 中传递字符串
    let currentSelectedText = '';

    function showSelectionTooltip(selection, x, y) {
        // 移除已存在的工具提示
        const existingTooltip = document.querySelector('.selection-tooltip');
        if (existingTooltip) {
            existingTooltip.remove();
        }

        const selectedText = selection.toString().trim();
        if (selectedText.length < 1) return; // 太短的文本不显示工具提示

        // 保存选中的文本到全局变量
        currentSelectedText = selectedText;

        const range = selection.getRangeAt(0);
        const rect = range.getBoundingClientRect();

        const tooltip = document.createElement('div');
        tooltip.className = 'selection-tooltip';

        // 计算工具提示位置，确保不超出屏幕边界
        let top = y - 45;
        let left = x;

        if (top < 10) {
            top = rect.bottom + 5;
        }

        if (left + 200 > window.innerWidth) {
            left = window.innerWidth - 210;
        }

        if (left < 10) {
            left = 10;
        }

        tooltip.style.cssText = `
            position: fixed;
            top: ${top}px;
            left: ${left}px;
            z-index: 10000;
        `;

        tooltip.innerHTML = `
            <button class="btn border-0 bg-transparent text-success p-1" title="保存摘录" data-action="excerpt">
                <i class="bi bi-bookmark-plus"></i>
            </button>
            <button class="btn border-0 bg-transparent text-info p-1" title="保存为模板" data-action="template">
                <i class="bi bi-file-text"></i>
            </button>
            <button class="btn border-0 bg-transparent text-primary p-1" title="重写" data-action="rewrite">
                <i class="bi bi-pencil"></i>
            </button>
            <button class="btn border-0 bg-transparent text-warning p-1" title="替换敏感词" data-action="sensitive">
                <i class="bi bi-shield-check"></i>
            </button>
        `;

        // 添加事件监听器
        tooltip.querySelectorAll('button[data-action]').forEach(button => {
            button.addEventListener('click', function (e) {
                e.stopPropagation();
                e.preventDefault();
                const action = this.getAttribute('data-action');

                switch (action) {
                    case 'excerpt':
                        saveExcerpt();
                        break;
                    case 'template':
                        tooltipTemplateClicked();
                        break;
                    case 'rewrite':
                        tooltipRewriteClicked();
                        break;
                    case 'sensitive':
                        tooltipSensitiveClicked();
                        break;
                }
                const existingTooltip = document.querySelector('.selection-tooltip');
                if (existingTooltip) {
                    existingTooltip.remove();
                }
            });
        });

        // 添加到DOM
        document.body.appendChild(tooltip);

        // 使用setInterval检查文本选择状态的自动移除逻辑
        tooltip.autoRemoveTimer = setInterval(() => {
            const currentSelection = window.getSelection().toString().trim();
            if (!currentSelection) {
                // 没有文本被选中时移除工具提示
                if (tooltip.parentElement) {
                    tooltip.remove();
                }
                clearInterval(tooltip.autoRemoveTimer);
            }
        }, 1000);

        // 鼠标悬停时暂停自动移除检查
        tooltip.addEventListener('mouseenter', function () {
            if (tooltip.autoRemoveTimer) {
                clearInterval(tooltip.autoRemoveTimer);
            }
        });

        tooltip.addEventListener('mouseleave', function () {
            // 鼠标离开后重新开始检查
            tooltip.autoRemoveTimer = setInterval(() => {
                const currentSelection = window.getSelection().toString().trim();
                if (!currentSelection) {
                    if (tooltip.parentElement) {
                        tooltip.remove();
                    }
                    clearInterval(tooltip.autoRemoveTimer);
                }
            }, 1000);
        });
    }

    function saveSelectedText() {
        const selection = window.getSelection();
        const selectedText = selection.toString().trim();

        if (!selectedText) {
            showAlert('请先选择要摘录的文本', 'warning');
            return;
        }

        saveExcerpt(selectedText);
    }

    async function saveExcerpt() {
        const token = localStorage.getItem('token');

        if (token) {
            // 登录用户保存到服务器
            try {
                const response = await fetch('/api/excerpts/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        book_id: currentBook.id,
                        chapter_id: chapters[currentChapterIndex].id,
                        content: currentSelectedText,
                        note: ''
                    })
                });

                if (response.ok) {
                    showAlert('摘录保存成功', 'success');
                } else {
                    throw new Error('保存失败');
                }
            } catch (error) {
                console.error('保存摘录失败:', error);
                showAlert('保存摘录失败，已保存到本地', 'warning');
            }
        }

        // 移除选择工具提示
        const tooltip = document.querySelector('.selection-tooltip');
        if (tooltip) {
            tooltip.remove();
        }

        // 清除选择
        window.getSelection().removeAllRanges();

        // 如果摘录面板打开，刷新列表
        if (!document.getElementById('excerptsPanel').classList.contains('d-none')) {
            displayExcerpts(excerpts);
        }
    }

    function removeExcerpt(id) {
        excerpts = excerpts.filter(excerpt => excerpt.id !== id);
        displayExcerpts(excerpts);
        showAlert('摘录删除成功', 'success');
    }

    function clearExcerpts() {
        if (confirm('确定要清空所有摘录吗？')) {
            excerpts = [];
            displayExcerpts(excerpts);
            showAlert('摘录已清空', 'success');
        }
    }

    // 章节跳转功能
    function showChapterJump() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">跳转到章节</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">章节号</label>
                        <input type="number" class="form-control" id="jumpChapterNumber" 
                               value="${currentChapterIndex + 1}" min="1" max="${chapters.length}" 
                               placeholder="输入章节号 (1-${chapters.length})">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">或选择章节</label>
                        <select class="form-select" id="jumpChapterSelect">
                            ${chapters.map((chapter, index) =>
            `<option value="${index}" ${index === currentChapterIndex ? 'selected' : ''}>
                                    第${chapter.chapter_number}章 - ${chapter.title}
                                </option>`
        ).join('')}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="jumpToChapter()">跳转</button>
                </div>
            </div>
        </div>
    `;

        document.body.appendChild(modal);
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();

        // 同步输入框和选择框
        const numberInput = modal.querySelector('#jumpChapterNumber');
        const selectInput = modal.querySelector('#jumpChapterSelect');

        numberInput.addEventListener('input', function () {
            const chapterIndex = parseInt(this.value) - 1;
            if (chapterIndex >= 0 && chapterIndex < chapters.length) {
                selectInput.value = chapterIndex;
            }
        });

        selectInput.addEventListener('change', function () {
            numberInput.value = parseInt(this.value) + 1;
        });

        // 模态框关闭后移除元素
        modal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modal);
        });
    }

    function jumpToChapter() {
        const chapterIndex = document.getElementById('chapterProgress').value - 1;

        if (chapterIndex >= 0 && chapterIndex < chapters.length) {
            loadChapter(chapterIndex);

            // 关闭模态框
            const modal = document.querySelector('.modal.show');
            if (modal) {
                bootstrap.Modal.getInstance(modal).hide();
            }
            preloadChapter(chapterIndex + 1);
        }
    }

    // 显示更多章节
    function showMoreChapters(direction) {
        if (direction === 'prev' && chapterDisplayRange.start > 0) {
            chapterDisplayRange.start = Math.max(0, chapterDisplayRange.start - CHAPTER_DISPLAY_COUNT);
            chapterDisplayRange.end = chapterDisplayRange.start + CHAPTER_DISPLAY_COUNT;
        } else if (direction === 'next' && chapterDisplayRange.end < chapters.length) {
            chapterDisplayRange.end = Math.min(chapters.length, chapterDisplayRange.end + CHAPTER_DISPLAY_COUNT);
            chapterDisplayRange.start = chapterDisplayRange.end - CHAPTER_DISPLAY_COUNT;
        }

        updateChapterList();
    }

    function showProgressOnNavigation() {
        // 进度条指示：根据滚动位置设置reader-navigation背景渐变
        const nav = document.querySelector('.reader-navigation');
        const scrollTop = window.pageYOffset;
        const docHeight = document.body.scrollHeight - window.innerHeight;
        let percent = 0;
        if (docHeight > 0) {
            percent = Math.min(1, scrollTop / docHeight);
        }
        nav.style.background = `linear-gradient(to right, #bcdff1 ${percent * 100}%, #e9ecef ${percent * 100}%)`;
    }

    // 点击外部关闭面板
    document.addEventListener('click', function (e) {
        const panels = ['settingsPanel', 'excerptsPanel', 'templatesPanel', 'rewritePanel', 'sensitiveWordsPanel'];
        const toolbar = document.querySelector('.reader-toolbar');

        if (!toolbar.contains(e.target)) {
            panels.forEach(panelId => {
                const panel = document.getElementById(panelId);
                if (!panel.contains(e.target)) {
                    panel.classList.add('d-none');
                }
            });
        }
    });

    // 定期保存阅读进度（智能检查，避免无意义的保存）
    setInterval(saveReadingProgress, 30000); // 每30秒保存一次，但只在有变化时保存
    setInterval(showProgressOnNavigation, 300); // 每300毫秒更新进度条

    // 页面卸载时强制保存进度
    window.addEventListener('beforeunload', function () {
        saveReadingProgress(true);
    });

    // ==================== 摘录功能 ====================

    async function saveSelectedText() {
        const selection = window.getSelection();
        const selectedText = selection.toString().trim();

        if (!selectedText) {
            showAlert('请先选择要摘录的文本', 'warning');
            return;
        }

        const token = localStorage.getItem('token');
        if (!token) {
            return;
        }

        // 保存到服务器
        try {
            const response = await fetch('/api/excerpts/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    book_id: currentBook.id,
                    chapter_id: chapters[currentChapterIndex].id,
                    content: selectedText,
                    note: ''
                })
            });

            if (response.ok) {
                showAlert('摘录保存成功', 'success');
                displayExcerpts(excerpts);
                selection.removeAllRanges();
            } else {
                throw new Error('保存失败');
            }
        } catch (error) {
            console.error('保存摘录失败:', error);
            showAlert('保存摘录失败，已保存到本地', 'warning');
        }
    }

    async function loadExcerpts() {
        const token = localStorage.getItem('token');
        if (!token) {
            showAlert('请先登录', 'warning');
            return;
        }

        try {
            const response = await fetch(`/api/excerpts/?book_id=${currentBook.id}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                excerpts = await response.json();
            }
        } catch (error) {
            console.error('加载服务器摘录失败:', error);
            showAlert('加载服务器摘录失败', 'danger');
        }
    }

    function displayExcerpts(excerptList) {
        const container = document.getElementById('excerptsList');

        if (excerptList.length === 0) {
            container.innerHTML = '<div class="text-center text-muted">暂无摘录</div>';
            return;
        }

        container.innerHTML = excerptList.map(excerpt => `
            <div class="excerpt-item mb-2 p-2 border rounded">
                <div class="excerpt-content">${excerpt.content}</div>
                <div class="excerpt-meta text-muted small mt-1">
                    ${new Date(excerpt.created_at).toLocaleString()}
                    ${excerpt.local ? '<span class="badge bg-secondary">本地</span>' : '<span class="badge bg-primary">服务器</span>'}
                </div>
                <div class="excerpt-actions mt-1">
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteExcerpt(${excerpt.id}, ${excerpt.local || false})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    async function deleteExcerpt(excerptId, isLocal) {
        if (isLocal) {
            excerpts = excerpts.filter(e => e.id !== excerptId);
            displayExcerpts(excerpts)
            showAlert('本地摘录删除成功', 'success');
            return;
        }

        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            const response = await fetch(`/api/excerpts/${excerptId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                showAlert('摘录删除成功', 'success');
                await loadExcerpts();
                displayExcerpts(excerpts);
            }
        } catch (error) {
            console.error('删除摘录失败:', error);
            showAlert('删除摘录失败', 'danger');
        }
    }

    // ==================== 模板功能 ====================

    let currentKeywords = [];

    function createTemplateFromSelection() {
        const selection = window.getSelection();
        const selectedText = selection.toString().trim();

        if (!selectedText) {
            showAlert('请先选择要创建模板的文本', 'warning');
            return;
        }

        currentSelectedText = selectedText;
        showCurrentSelectedTemplateForm();
    }

    function showCurrentSelectedTemplateForm() {
        document.getElementById('templatesPanel').style.width = '70%';
        document.getElementById('templateContent').value = currentSelectedText;
        document.getElementById('createTemplateForm').classList.remove('d-none');
        // 自动提取关键词
        extractKeywords();
    }

    async function extractKeywords() {
        const content = document.getElementById('templateContent').value.trim();
        if (!content) return;

        // 综合姓氏列表（单姓 + 复姓）
        const surnames = new Set([
            '李', '王', '张', '刘', '陈', '杨', '赵', '黄', '周', '吴',
            '徐', '孙', '胡', '朱', '高', '林', '何', '郭', '马', '罗',
            '梁', '宋', '郑', '谢', '韩', '唐', '冯', '于', '董', '萧',
            '程', '曹', '袁', '邓', '许', '傅', '沈', '曾', '彭', '吕',
            '苏', '卢', '蒋', '蔡', '贾', '丁', '魏', '薛', '叶', '阎',
            '余', '潘', '杜', '戴', '夏', '钟', '汪', '田', '任', '姜',
            '范', '方', '石', '姚', '谭', '廖', '邹', '熊', '金', '陆',
            '郝', '孔', '白', '崔', '康', '毛', '邱', '秦', '江', '史',
            '顾', '侯', '邵', '孟', '龙', '万', '段', '雷', '钱', '汤',
            '尹', '黎', '易', '常', '武', '乔', '贺', '赖', '龚', '文',
            '欧阳', '司马', '上官', '司徒', '诸葛', '夏侯', '东方', '南宫'
        ]);

        function isChineseCharacters(str) {
            return /^[\u4e00-\u9fa5]+$/.test(str);
        }

        const names = new Set();
        const cleanContent = content.replace(/[\s\.,，。!！?？;；:：、（）()《》""''"“”]/g, '');
        
        // 预定义一些常见的非名字词语，用于过滤误识别
        const commonWords = new Set(['今天', '明天', '昨天', '我们', '你们', '他们', '这个', '那个', '这里', '那里']);
        const noendings = new Set([
            '的', '了', '在', '是', '有', '和', '就', '都', '被', '从', '以', '为', '上', '要', '出', '一', '这',
            '那', '他', '她', '它', '我', '你', '们', '什', '么', '怎', '样', '哪', '候', '地', '个', '说', '话',
            '看', '见', '听', '到', '想', '着', '了', '吗', '呢', '吧', '啊', '呀', '哦', '嗯', '与', '哼', '嘿',
            '嘻', '哈', '呵', '嘿', '咦', '哇', '哎', '唉', '哟', '喂', '喔', '噢', '嗨', '咳', '咯', '嗯', '唔',
            '嗷', '哼', '哦', '啊', '呀', '哎', '唉', '哟', '喂', '喔', '噢', '嗨', '咳', '咯', '嗯', '唔', '嗷']);
        
        for (let i = 0; i < cleanContent.length; i++) {
            // 检查所有可能的2-4字符组合
            for (let len = 2; len <= 4 && i + len <= cleanContent.length; len++) {
                const candidate = cleanContent.substring(i, i + len);
                
                // 基本验证：全中文且不在常见词语列表中
                if (!isChineseCharacters(candidate) || commonWords.has(candidate) || noendings.has(candidate[len - 1])) {
                    continue;
                }
                
                let isValidName = false;
                
                if (len === 2) {
                    // 2字符：单姓+单名
                    const surname = candidate[0];
                    if (surnames.has(surname)) {
                        isValidName = true;
                    }
                } else if (len === 3) {
                    // 3字符：可能是单姓+双名 或 复姓+单名
                    const singleSurname = candidate[0];
                    const compoundSurname = candidate.substring(0, 2);
                    
                    if (surnames.has(singleSurname) || surnames.has(compoundSurname)) {
                        isValidName = true;
                    }
                } else if (len === 4) {
                    // 4字符：复姓+双名
                    const compoundSurname = candidate.substring(0, 2);
                    if (surnames.has(compoundSurname)) {
                        isValidName = true;
                    }
                }
                if (isValidName) {
                    names.add(candidate);
                }
            }
        }
        let suggested_keywords = {};
        let index = 1;
        if (content.includes('我')) {
            suggested_keywords['man1'] = '我';
            index += 1;
        }
        names.forEach(name => {
            suggested_keywords['man' + index] = name;
            index += 1;
        })
        displayKeywordsList(suggested_keywords);
    }

    function displayKeywordsList(suggestedKeywords) {
        const container = document.getElementById('keywordsList');
        currentKeywords = [];

        let html = '';
        Object.entries(suggestedKeywords).forEach(([key, value]) => {
            html += `
                <div class="d-flex align-items-center mb-2">
                    <input type="checkbox" class="form-check-input me-2" id="keyword_${key}" 
                           onchange="toggleKeyword('${key}', '${value}')">
                    <label class="form-check-label me-2" for="keyword_${key}">${key}:</label>
                    <span class="text-primary">${value}</span>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function toggleKeyword(key, value) {
        const checkbox = document.getElementById(`keyword_${key}`);
        const content = document.getElementById('templateContent');

        if (checkbox.checked) {
            // 添加关键词
            if (!currentKeywords.includes(key)) {
                currentKeywords.push(key);
            }
            // 替换内容中的文本为模板变量
            content.value = content.value.replace(new RegExp(value, 'g'), `{${key}}`);
        } else {
            // 移除关键词
            currentKeywords = currentKeywords.filter(k => k !== key);
            // 恢复原文本
            content.value = content.value.replace(new RegExp(`\\{${key}\\}`, 'g'), value);
        }
    }

    function addCustomKeyword() {
        const key = document.getElementById('customKeyword').value.trim();
        const value = document.getElementById('customKeywordValue').value.trim();
        if (!value || !key) {
            showAlert('请输入关键词和文本', 'warning');
            return;
        }

        if (currentKeywords.includes(key)) {
            showAlert('关键词已存在', 'warning');
            return;
        }

        const content = document.getElementById('templateContent');
        if (content.value.includes(value)) {
            currentKeywords.push(key);
            content.value = content.value.replace(new RegExp(value, 'g'), `{${key}}`);

            // 更新显示
            const container = document.getElementById('keywordsList');
            container.innerHTML += `
                <div class="d-flex align-items-center mb-2">
                    <input type="checkbox" class="form-check-input me-2" checked 
                           onchange="toggleKeyword('${key}', '${value}')">
                    <label class="form-check-label me-2">${key}:</label>
                    <span class="text-primary">${value}</span>
                </div>
            `;
            document.getElementById('customKeywordValue').value = '';
        } else {
            showAlert('在模板内容中未找到指定文本', 'warning');
        }
    }

    async function saveTemplate() {
        const name = document.getElementById('templateName').value.trim();
        const content = document.getElementById('templateContent').value.trim();
        const tags = document.getElementById('templateTags').value.trim().split(',').map(t => t.trim()).filter(t => t);
        const description = document.getElementById('templateDescription').value.trim();

        if (!name || !content) {
            showAlert('请填写模板名称和内容', 'warning');
            return;
        }

        if (currentKeywords.length === 0) {
            showAlert('请至少设置一个关键词', 'warning');
            return;
        }

        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            const response = await fetch('/api/templates/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    name: name,
                    content: content,
                    keywords: currentKeywords,
                    tags: tags,
                    description: description
                })
            });

            if (response.ok) {
                showAlert('模板保存成功', 'success');
                cancelCreateTemplate();
                loadUserTemplates();
            } else {
                const error = await response.json();
                showAlert(error.detail || '保存模板失败', 'danger');
            }
        } catch (error) {
            console.error('保存模板失败:', error);
            showAlert('保存模板失败', 'danger');
        }
    }

    function cancelCreateTemplate() {
        document.getElementById('templatesPanel').style.width = '';
        document.getElementById('templateName').value = '';
        document.getElementById('templateContent').value = '';
        document.getElementById('templateTags').value = '';
        document.getElementById('templateDescription').value = '';
        document.getElementById('keywordsList').innerHTML = '';
        currentKeywords = [];
    }

    async function loadUserTemplates() {
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            const response = await fetch('/api/templates/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const templates = await response.json();
                displayTemplates(templates);
            }
        } catch (error) {
            console.error('加载模板失败:', error);
        }
    }

    function displayTemplates(templates) {
        const container = document.getElementById('templatesList');

        if (templates.length === 0) {
            container.innerHTML = '<div class="text-center text-muted">暂无模板</div>';
            return;
        }

        container.innerHTML = templates.map(template => `
            <div class="template-item mb-3 p-3 border rounded">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6>${template.name}</h6>
                        <p class="text-muted small mb-2">${template.description || '无描述'}</p>
                        <div class="mb-2">
                            ${template.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('')}
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">关键词: ${template.keywords.join(', ')}</small>
                        </div>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="useTemplate(${template.id})">
                            使用
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteTemplate(${template.id})">
                            删除
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async function useTemplate(templateId) {
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            const response = await fetch(`/api/templates/${templateId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const template = await response.json();
                showTemplateApplyDialog(template);
            }
        } catch (error) {
            console.error('获取模板失败:', error);
        }
    }

    function showTemplateApplyDialog(template) {
        let html = `
            <div class="modal fade" id="applyTemplateModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">应用模板: ${template.name}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p class="text-muted">${template.description || ''}</p>
        `;

        template.keywords.forEach(keyword => {
            html += `
                <div class="mb-3">
                    <label class="form-label">${keyword}</label>
                    <input type="text" class="form-control" id="keyword_value_${keyword}" placeholder="输入${keyword}的值">
                </div>
            `;
        });

        html += `
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" onclick="applyTemplate(${template.id})">应用</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // 移除现有模态框
        const existingModal = document.getElementById('applyTemplateModal');
        if (existingModal) {
            existingModal.remove();
        }

        document.body.insertAdjacentHTML('beforeend', html);
        const modal = new bootstrap.Modal(document.getElementById('applyTemplateModal'));
        modal.show();
    }

    async function applyTemplate(templateId) {
        const token = localStorage.getItem('token');
        if (!token) return;

        // 收集关键词值
        const keywordValues = {};
        const inputs = document.querySelectorAll('[id^="keyword_value_"]');

        for (const input of inputs) {
            const keyword = input.id.replace('keyword_value_', '');
            const value = input.value.trim();
            if (!value) {
                showAlert(`请填写${keyword}的值`, 'warning');
                return;
            }
            keywordValues[keyword] = value;
        }
        // """应用模板"""
        // template = db.query(Template).filter(
        //     Template.id == apply_data.template_id,
        //     Template.user_id == current_user.id
        // ).first()

        // if not template:
        //     raise HTTPException(status_code=404, detail="模板不存在")

        // # 解析关键词
        // keywords = json.loads(template.keywords)

        // # 检查是否提供了所有必需的关键词值
        // for keyword in keywords:
        //     if keyword not in apply_data.keyword_values:
        //         raise HTTPException(
        //             status_code=400,
        //             detail=f"缺少关键词值: {keyword}"
        //         )

        // # 应用模板
        // result_content = template.content
        // for keyword, value in apply_data.keyword_values.items():
        //     result_content = result_content.replace(f"{keyword}", value)

        // return {
        //     "content": result_content,
        //     "template_name": template.name
        // }

        try {
            const response = await fetch('/api/templates/apply', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    template_id: templateId,
                    keyword_values: keywordValues
                })
            });

            if (response.ok) {
                const result = await response.json();

                // 将结果插入到重写面板
                document.getElementById('rewrittenContent').value = result.content;

                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('applyTemplateModal'));
                modal.hide();

                showAlert('模板应用成功', 'success');
            }
        } catch (error) {
            console.error('应用模板失败:', error);
            showAlert('应用模板失败', 'danger');
        }
    }

    async function deleteTemplate(templateId) {
        if (!confirm('确定要删除这个模板吗？')) return;

        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            const response = await fetch(`/api/templates/${templateId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                showAlert('模板删除成功', 'success');
                loadUserTemplates();
            }
        } catch (error) {
            console.error('删除模板失败:', error);
            showAlert('删除模板失败', 'danger');
        }
    }

    // ==================== 重写功能 ====================

    let currentRewriteType = '';
    let currentRewritePosition = 0;

    function startRewrite() {
        const selection = window.getSelection();
        const selectedText = selection.toString().trim();

        if (!selectedText) {
            showAlert('请先选择要重写的文本', 'warning');
            return;
        }

        currentRewriteType = 'rewrite';
        document.getElementById('originalContent').value = selectedText;
        document.getElementById('rewrittenContent').value = '';
        document.getElementById('rewriteForm').classList.remove('d-none');
        document.getElementById('templateSelector').style.display = 'block';

        // 计算选中文本在章节中的位置
        const range = selection.getRangeAt(0);
        currentRewritePosition = range.startOffset;
    }

    function startInsert() {
        const selection = window.getSelection();

        currentRewriteType = 'insert';
        document.getElementById('originalContent').value = '';
        document.getElementById('rewrittenContent').value = '';
        document.getElementById('rewriteForm').classList.remove('d-none');
        document.getElementById('templateSelector').style.display = 'block';

        // 计算插入位置
        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            currentRewritePosition = range.startOffset;
        } else {
            currentRewritePosition = 0;
        }
    }

    async function loadTemplatesForRewrite() {
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            const response = await fetch('/api/templates/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const templates = await response.json();
                const select = document.getElementById('templateSelect');
                select.innerHTML = '<option value="">选择模板</option>' +
                    templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            }
        } catch (error) {
            console.error('加载模板失败:', error);
        }
    }

    async function applySelectedTemplate() {
        const templateId = document.getElementById('templateSelect').value;
        if (!templateId) {
            showAlert('请选择一个模板', 'warning');
            return;
        }

        await useTemplate(parseInt(templateId));
    }

    async function saveRewrite() {
        const originalContent = document.getElementById('originalContent').value;
        const rewrittenContent = document.getElementById('rewrittenContent').value.trim();

        if (!rewrittenContent) {
            showAlert('请输入重写内容', 'warning');
            return;
        }

        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            const response = await fetch('/api/rewrites/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    book_id: currentBook.id,
                    chapter_id: chapters[currentChapterIndex].id,
                    original_content: originalContent,
                    rewritten_content: rewrittenContent,
                    position: currentRewritePosition,
                    type: currentRewriteType
                })
            });

            if (response.ok) {
                showAlert('重写保存成功', 'success');
                cancelRewrite();
                loadUserRewrites();
            } else {
                const error = await response.json();
                showAlert(error.detail || '保存重写失败', 'danger');
            }
        } catch (error) {
            console.error('保存重写失败:', error);
            showAlert('保存重写失败', 'danger');
        }
    }

    function cancelRewrite() {
        document.getElementById('rewriteForm').classList.add('d-none');
        document.getElementById('originalContent').value = '';
        document.getElementById('rewrittenContent').value = '';
        document.getElementById('templateSelector').style.display = 'none';
        currentRewriteType = '';
        currentRewritePosition = 0;
    }

    async function loadUserRewrites() {
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            const response = await fetch(`/api/rewrites/?chapter_id=${chapters[currentChapterIndex].id}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const rewrites = await response.json();
                displayRewrites(rewrites);
            }
        } catch (error) {
            console.error('加载重写失败:', error);
        }
    }

    function displayRewrites(rewrites) {
        const container = document.getElementById('rewritesList');

        if (rewrites.length === 0) {
            container.innerHTML = '<div class="text-center text-muted">暂无重写内容</div>';
            return;
        }

        container.innerHTML = rewrites.map(rewrite => `
            <div class="rewrite-item mb-3 p-3 border rounded">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="mb-2">
                            <span class="badge ${rewrite.type === 'rewrite' ? 'bg-primary' : 'bg-success'}">
                                ${rewrite.type === 'rewrite' ? '重写' : '插入'}
                            </span>
                        </div>
                        ${rewrite.original_content ? `
                            <div class="mb-2">
                                <small class="text-muted">原文:</small>
                                <div class="text-muted">${rewrite.original_content}</div>
                            </div>
                        ` : ''}
                        <div class="mb-2">
                            <small class="text-muted">重写:</small>
                            <div>${rewrite.rewritten_content}</div>
                        </div>
                        <small class="text-muted">${new Date(rewrite.created_at).toLocaleString()}</small>
                    </div>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteRewrite(${rewrite.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    async function deleteRewrite(rewriteId) {
        if (!confirm('确定要删除这个重写吗？')) return;

        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            const response = await fetch(`/api/rewrites/${rewriteId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                showAlert('重写删除成功', 'success');
                loadUserRewrites();
            }
        } catch (error) {
            console.error('删除重写失败:', error);
            showAlert('删除重写失败', 'danger');
        }
    }

    // ==================== 工具提示相关函数 ====================

    function tooltipTemplateClicked(e) {
        const token = localStorage.getItem('token');
        if (!token) {
            showAlert('模板功能需要登录后使用', 'warning');
            return;
        }

        // 打开模板面板并填充选中的文本
        toggleTemplates();
        setTimeout(() => {
            showCurrentSelectedTemplateForm();
        }, 100);
    }

    function tooltipRewriteClicked() {
        const token = localStorage.getItem('token');
        if (!token) {
            showAlert('重写功能需要登录后使用', 'warning');
            return;
        }

        // 打开重写面板并设置为重写模式
        toggleRewrite();
        setTimeout(() => {
            currentRewriteType = 'rewrite';
            document.getElementById('originalContent').value = currentSelectedText;
            document.getElementById('rewrittenContent').value = '';
            document.getElementById('rewriteForm').classList.remove('d-none');
            document.getElementById('templateSelector').style.display = 'block';

            // 计算选中文本的位置
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                currentRewritePosition = range.startOffset;
            }
        }, 100);
    }

    function tooltipSensitiveClicked() {
        // 打开敏感词面板
        toggleSensitiveWords();

        // 可以在这里添加预填充敏感词的逻辑
        setTimeout(() => {
            const newSensitiveWordInput = document.getElementById('newSensitiveWord');
            if (newSensitiveWordInput && currentSelectedText.length < 20) {
                // 如果选中文本较短，可以作为敏感词候选
                newSensitiveWordInput.value = currentSelectedText;
            }
        }, 100);
    }
</script>
{% endblock %}