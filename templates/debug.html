<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API调试页面</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>API调试工具</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>测试导入API</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">书源ID</label>
                            <input type="number" class="form-control" id="sourceId" value="1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">书籍URL</label>
                            <input type="url" class="form-control" id="bookUrl" 
                                   value="https://example.com/book/123">
                        </div>
                        <button class="btn btn-primary" onclick="testImportAPI()">测试导入</button>
                        <div id="importResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>测试检测API</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">书籍URL</label>
                            <input type="url" class="form-control" id="detectUrl" 
                                   value="https://www.qidian.com/book/123">
                        </div>
                        <button class="btn btn-info" onclick="testDetectAPI()">测试检测</button>
                        <div id="detectResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>书源列表</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-secondary" onclick="loadSources()">加载书源</button>
                        <div id="sourcesList" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function testImportAPI() {
            const sourceId = document.getElementById('sourceId').value;
            const bookUrl = document.getElementById('bookUrl').value;
            const resultDiv = document.getElementById('importResult');
            
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> 测试中...';
            
            try {
                const response = await fetch('/api/sources/import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        source_id: parseInt(sourceId),
                        book_url: bookUrl
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>成功 (${response.status})</strong><br>
                            ${JSON.stringify(result, null, 2)}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>失败 (${response.status})</strong><br>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>网络错误</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }
        
        async function testDetectAPI() {
            const bookUrl = document.getElementById('detectUrl').value;
            const resultDiv = document.getElementById('detectResult');
            
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> 检测中...';
            
            try {
                const response = await fetch('/api/sources/detect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        book_url: bookUrl
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>成功 (${response.status})</strong><br>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>失败 (${response.status})</strong><br>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>网络错误</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }
        
        async function loadSources() {
            const resultDiv = document.getElementById('sourcesList');
            
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> 加载中...';
            
            try {
                const response = await fetch('/api/sources/');
                const sources = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-info">
                            <strong>书源列表 (${sources.length}个)</strong><br>
                            <pre>${JSON.stringify(sources, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            加载失败: ${response.status}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        网络错误: ${error.message}
                    </div>
                `;
            }
        }
        
        // 页面加载时自动加载书源
        document.addEventListener('DOMContentLoaded', function() {
            loadSources();
        });
    </script>
</body>
</html>